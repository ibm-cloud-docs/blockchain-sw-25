---

copyright:
  years: 2020
lastupdated: "2020-10-30"

keywords: HSM, Gemalto, IBM Cloud

subcollection: blockchain-sw-25

---

{:DomainName: data-hd-keyref="APPDomain"}
{:DomainName: data-hd-keyref="DomainName"}
{:android: data-hd-operatingsystem="android"}
{:apikey: data-credential-placeholder='apikey'}
{:app_key: data-hd-keyref="app_key"}
{:app_name: data-hd-keyref="app_name"}
{:app_secret: data-hd-keyref="app_secret"}
{:app_url: data-hd-keyref="app_url"}
{:authenticated-content: .authenticated-content}
{:beta: .beta}
{:c#: data-hd-programlang="c#"}
{:codeblock: .codeblock}
{:curl: .ph data-hd-programlang='curl'}
{:deprecated: .deprecated}
{:dotnet-standard: .ph data-hd-programlang='dotnet-standard'}
{:download: .download}
{:external: target="_blank" .external}
{:faq: data-hd-content-type='faq'}
{:fuzzybunny: .ph data-hd-programlang='fuzzybunny'}
{:generic: data-hd-operatingsystem="generic"}
{:generic: data-hd-programlang="generic"}
{:gif: data-image-type='gif'}
{:go: .ph data-hd-programlang='go'}
{:help: data-hd-content-type='help'}
{:hide-dashboard: .hide-dashboard}
{:hide-in-docs: .hide-in-docs}
{:important: .important}
{:ios: data-hd-operatingsystem="ios"}
{:java: #java .ph data-hd-programlang='java'}
{:java: .ph data-hd-programlang='java'}
{:java: data-hd-programlang="java"}
{:javascript: .ph data-hd-programlang='javascript'}
{:javascript: data-hd-programlang="javascript"}
{:new_window: target="_blank"}
{:note: .note}
{:objectc data-hd-programlang="objectc"}
{:org_name: data-hd-keyref="org_name"}
{:php: data-hd-programlang="php"}
{:pre: .pre}
{:preview: .preview}
{:python: .ph data-hd-programlang='python'}
{:python: data-hd-programlang="python"}
{:route: data-hd-keyref="route"}
{:row-headers: .row-headers}
{:ruby: .ph data-hd-programlang='ruby'}
{:ruby: data-hd-programlang="ruby"}
{:runtime: architecture="runtime"}
{:runtimeIcon: .runtimeIcon}
{:runtimeIconList: .runtimeIconList}
{:runtimeLink: .runtimeLink}
{:runtimeTitle: .runtimeTitle}
{:screen: .screen}
{:script: data-hd-video='script'}
{:service: architecture="service"}
{:service_instance_name: data-hd-keyref="service_instance_name"}
{:service_name: data-hd-keyref="service_name"}
{:shortdesc: .shortdesc}
{:space_name: data-hd-keyref="space_name"}
{:step: data-tutorial-type='step'}
{:subsection: outputclass="subsection"}
{:support: data-reuse='support'}
{:swift: #swift .ph data-hd-programlang='swift'}
{:swift: .ph data-hd-programlang='swift'}
{:swift: data-hd-programlang="swift"}
{:table: .aria-labeledby="caption"}
{:term: .term}
{:tip: .tip}
{:tooling-url: data-tooling-url-placeholder='tooling-url'}
{:troubleshoot: data-hd-content-type='troubleshoot'}
{:tsCauses: .tsCauses}
{:tsResolve: .tsResolve}
{:tsSymptoms: .tsSymptoms}
{:tutorial: data-hd-content-type='tutorial'}
{:unity: .ph data-hd-programlang='unity'}
{:url: data-credential-placeholder='url'}
{:user_ID: data-hd-keyref="user_ID"}
{:vb.net: .ph data-hd-programlang='vb.net'}
{:video: .video}


# IBM Cloud Hardware Security Module (HSM)
{: #ibp-hsm-gemalto}
{: help}
{: support}

{{site.data.keyword.blockchainfull}} Platform 2.5.1 is now available and includes a simpler and faster HSM solution. Upgrade your environment and [configure an HSM client image](/docs/blockchain-sw-251?topic=blockchain-sw-251-ibp-hsm-gemalto) instead of using the PKCS #11 proxy. For upgrade instructions, see upgrading your console and components for [Openshift](/docs/blockchain-sw-251?topic=blockchain-sw-251-upgrade-ocp) or [Kubernetes](/docs/blockchain-sw-251?topic=blockchain-sw-251-upgrade-k8).
{: note}

{{site.data.keyword.cloud_notm}} includes an [HSM](#x6704988){: term}
service that provides cryptographic processing for key generation, encryption, decryption, and key storage. This document describes how to use that service with the {{site.data.keyword.blockchainfull}} Platform.
{: shortdesc}

While this tutorial focuses specifically on using {{site.data.keyword.cloud_notm}} HSM, you can learn more about the overall configuration process for using any HSM that supports PCKS #11 with the {{site.data.keyword.blockchainfull_notm}} Platform, see
[Configuring a node to use a Hardware Security Module](/docs/blockchain-sw-25?topic=blockchain-sw-25-ibp-console-adv-deployment#ibp-console-adv-deployment-cfg-hsm).

## Why would I want to use an HSM with my {{site.data.keyword.blockchainfull_notm}} Platform network?
{: #ibp-hsm-gemalto-why}

When a Certificate Authority (CA), peer, or ordering node is configured to use an HSM, their private key is generated by and protected inside a tamper resistant HSM device. {{site.data.keyword.cloud_notm}} HSM is a FIPS 140-2 Level 3 validated, single-tenant device that implements Gemalto (Luna) HSM. When a CA is configured to use HSM, the CA root private key is stored in the HSM. This is the key that is used to sign enrollment requests. After a peer or ordering node is configured to use HSM, the nodes are able to sign and endorse transactions without ever exposing their private key.

Because only the private keys of node identities are secured in the HSM, when you enroll other admin or client application identities with a CA, their private keys are not stored inside the HSM because they will need their private key to transact on the network.  
{: important}

## Using {{site.data.keyword.cloud_notm}} HSM
{: #ibp-hsm-gemalto-using}

{{site.data.keyword.cloud_notm}} HSM 6.0 and 7.0 are available in the [{{site.data.keyword.cloud_notm}} catalog](/catalog/infrastructure/hardware-security-module){: external}. Both versions are supported, however, these instructions focus on how to configure {{site.data.keyword.cloud_notm}} HSM 6.0 to work with the {{site.data.keyword.blockchainfull_notm}} Platform. If you are using 7.0, it is possible that some of the commands will differ slightly.

## Process overview
{: #ibp-hsm-gemalto-overview}

- [Part One: Set up the HSM device and HSM client](#ibp-hsm-gemalto-part-one)

  This process involves deploying an **HSM** and configuring a partition as well as deploying an **HSM client** that you will use to configure the device. Throughout these instructions you will run some commands from the HSM server and others from the HSM client. For clarity, we prefix these steps with either <img src="../images/icon-hsm-2.png" alt="HSM server" width="30" style="width:30px; border-style: none"/> or <img src="../images/icon-hsm-client.png" alt="HSM client" width="30" style="width:30px; border-style: none"/>.

- [Part Two: Configure communications between the HSM server and client](#ibp-hsm-gemalto-part-two)

  Communications between the HSM and client require a **Network Trust Link (NTL)** -- an encrypted, secure communications channel between the HSM and client. NTL uses digital certificates that the client and HSM server can use to verify each other's identity. You will run a command to get the HSM server certificate that allows the client to communicate with the HSM server. Likewise, you will generate a certificate and private key for the client and then copy them to the HSM server.

- [Part Three: Register the client with the HSM server](#ibp-hsm-gemalto-part-three)

  After the secure communications are configured, you can register the client with the HSM server and then assign the HSM partition to the client.

This process requires [Docker](https://docs.docker.com/install/){: external} to be installed on the machine where the HSM client is running and that you are familiar with the process for building Docker images. It also presumes you are comfortable with using the Kubernetes CLI to administer your Kubernetes cluster.



When the entire HSM configuration is complete, it resembles the following diagram:



### Part One: Set up the HSM device and HSM client
{: #ibp-hsm-gemalto-part-one}

1. Provision the HSM and configure it with at least one partition. For example, you can follow instructions for [Provisioning {{site.data.keyword.cloud_notm}} HSM](/docs/hardware-security-modules?topic=hardware-security-modules-provisioning-ibm-cloud-hsm){: external}.

   Be sure to record the `Label` and `PIN` for the partition. You will need to provide these values later when you configure a blockchain node to use this HSM partition. Also, save the IP address associated with the HSM device. We will refer to this value throughout these instructions as `<HSM_ADDRESS>`.
   {: important}

2. [Install the HSM client](/docs/hardware-security-modules?topic=hardware-security-modules-installing-the-ibm-cloud-hsm-client){: external} on your local machine. **Make sure the client version that you are running matches the HSM server version.** Record the IP address or fully qualified host name where the HSM client is running. We will refer to this value throughout these instructions as `<CLIENT_ADDRESS>`.

  The client runs on AIX, Linux, Oracle Solaris, or Microsoft Windows, but is not supported on MacOS.
  {: tip}

### Part Two: Configure communications between the HSM server and client
{: #ibp-hsm-gemalto-part-two}

In this section you will get the HSM server certificate and create the HSM client certificate-key pair in order for them to be exchanged.

1. <img src="../images/icon-hsm-client.png" alt="HSM client" width="30" style="width:30px; border-style: none"/> Run the following command using the HSM client to get the server certificate. This certificate enables the client to communicate with the server.

  ```bash
  scp hsm_admin@<HSM_ADDRESS>:server.pem server.pem
  ```
  {: codeblock}

  Replace
  - `<HSM_ADDRESS>` with the IP address of the HSM.

2. <img src="../images/icon-hsm-client.png" alt="HSM client" width="30" style="width:30px; border-style: none"/> Now, add the HSM server to the client configuration by running the following command:

  ```bash
  vtl addServer -n <HSM_ADDRESS> -c server.pem
  ```
  {: codeblock}

  Replace
  - `<HSM_ADDRESS>` with the IP address of the HSM.

3. <img src="../images/icon-hsm-client.png" alt="HSM client" width="30" style="width:30px; border-style: none"/> Create the certificate and private key for the client by running the command:

  ```bash
  vtl createcert -n <CLIENT_ADDRESS>
  ```
  {: codeblock}

  Replace
  - `<CLIENT_ADDRESS>` with the IP address or fully qualified host name of the client.

  The name of the generated certificates includes the `<CLIENT_ADDRESS>`. The output of this command looks similar to:
  ```
  Private Key created and written to: /usr/safenet/lunaclient/cert/client/<CLIENT_ADDRESS>Key.pem
  Certificate created and written to: /usr/safenet/lunaclient/cert/client/<CLIENT_ADDRESS>.pem
  ```

4. <img src="../images/icon-hsm-client.png" alt="HSM client" width="30" style="width:30px; border-style: none"/> Copy the client certificate and private key to the HSM server by running the command:

  ```bash
  scp /usr/safenet/lunaclient/cert/client/<CLIENT_ADDRESS>.pem hsm_admin@<HSM_ADDRESS>:.
  ```
  {: codeblock}

  Replace
  - `<CLIENT_ADDRESS>` with the IP address or fully qualified host name of the client.
  - `<HSM_ADDRESS>` with the IP address of the HSM.

### Part Three: Register the client with the HSM server
{: #ibp-hsm-gemalto-part-three}

1. <img src="../images/icon-hsm-2.png" alt="HSM server" width="30" style="width:30px; border-style: none"/> SSH into the HSM as the admin the HSM server and register the client by running **one** of the following commands.

  If the `<CLIENT_ADDRESS>` is the IP address of the client:

  ```bash
  client register -client ${CLIENT_NAME} -ip <CLIENT_ADDRESS>
  ```
  {: codeblock}

  If the `<CLIENT_ADDRESS>` is the fully qualified host name of the client:

  ```bash
  client register -client ${CLIENT_NAME} -hostname <CLIENT_ADDRESS>
  ```
  {: codeblock}

  Replace
  - `{CLIENT_NAME}` with the name of the client. This value can be anything meaningful to you.
  - `<CLIENT_ADDRESS>` with either the IP address or fully qualified host name of the client.

2. <img src="../images/icon-hsm-2.png" alt="HSM server" width="30" style="width:30px; border-style: none"/> Because network address translation (NAT) exists between the client and the HSM, we need to disable client source IP address validation by the Network Trust Link Server (NTLS) upon Network Trust Link Agent (NTLA) client connection.  Disable ip check on the HSM server and then restart the NTLS service on the HSM server by running the following commands:

  ```bash
  ntls ipcheck disable
  service restart ntls
  ```
  {: codeblock}

3. <img src="../images/icon-hsm-2.png" alt="HSM server" width="30" style="width:30px; border-style: none"/> Assign a partition to the newly created client on the HSM server by running the following command:

  ```bash
  client assignpartition -client ${CLIENT_NAME} -partition ${PARTITION_NAME}
  ```
  {: codeblock}

  Replace
  - `{CLIENT_NAME}` with the name that you gave to your HSM client.
  - `{PARTITION_NAME}` with the name of the HSM partition you created in [Part one](#ibp-hsm-gemalto-part-one), step 1.

  You can verify the command worked by running the following command:

  ```bash
  client show -client ${CLIENT_NAME}
  ```
  {: codeblock}

  The output will look similar to:

  ```
  ClientID:     hsmclient
  IPAddress:    10.220.203.73
  HTL Required: no
  OTT Expiry:   n/a
  Partitions:   "partition1"

  Command Result : 0 (Success)
  ```

4. <img src="../images/icon-hsm-client.png" alt="HSM client" width="30" style="width:30px; border-style: none"/> Verify the client can connect to HSM server by running the command:

  ```bash
  vtl verify
  ```
  {: codeblock}

  The output will look similar to:

  ```
  The following Luna SA Slots/Partitions were found:
  Slot	Serial #        	Label
  ====	================	=====
  0	    500752010 	      partition1
  ```

5. <img src="../images/icon-hsm-client.png" alt="HSM client" width="30" style="width:30px; border-style: none"/>  Create a `configs` folder on the client and then copy the `server.pem` certificate from [Part two](#ibp-hsm-gemalto-part-two), step 1 and the `<CLIENT_ADDRESS>Key.pem` and `<CLIENT_ADDRESS>.pem` files from [Part two](#ibp-hsm-gemalto-part-two), step 3 into the folder:

   - Copy `server.pem` to `configs/server.pem`  
   - Copy `/usr/safenet/lunaclient/cert/client/<CLIENT_ADDRESS>Key.pem` to `configs/key.pem`  
   - Copy `/usr/safenet/lunaclient/cert/client/<CLIENT_ADDRESS>.pem` to `configs/cert.pem`  





### What's next
{: #ibp-hsm-gemalto-next-steps}

After you have used these instructions to configure your {{site.data.keyword.cloud_notm}} HSM and build the  **PKCS #11 proxy**, you are ready to configure your blockchain nodes to use the HSM. When you create a CA, peer, or ordering node, select the [HSM Advanced deployment option](/docs/blockchain-sw-25?topic=blockchain-sw-25-ibp-console-adv-deployment#ibp-console-adv-deployment-cfg-hsm-node) to configure the node to use this HSM.  



When the node is deployed, a private key for the specified node enroll ID and secret is generated by the HSM and stored securely in the appliance.

## Using multiple partitions
{: #ibp-hsm-gemalto-multiple-partitions}

If your HSM has multiple partitions, only one PKCS #11 proxy is required to communicate with the HSM.
